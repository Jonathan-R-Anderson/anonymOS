module minimal_os.display.bitmap_font;

import minimal_os.display.framebuffer : glyphHeight, glyphWidth;

/// Lightweight bitmap font source used as a stand-in for a full FreeType
/// pipeline. The data is intentionally small and static so that the kernel can
/// shape and cache text without dynamic allocation.
struct BitmapFont
{
    bool available;
    /// Expanded 8x16 glyphs for the ASCII subset. Each row is a byte mask where
    /// the high bit maps to the left-most pixel.
    ubyte[glyphHeight][128] glyphs;
    /// Fallback glyph used when a codepoint is missing.
    ubyte[glyphHeight] fallback;
}

/// Built-in 8x8 ASCII bitmaps sourced from the classic font8x8 dataset. Rows
/// are duplicated vertically to create an 8x16 cell, matching the framebuffer
/// console metrics used elsewhere in the OS.
private immutable ubyte[8][128] font8x8Basic = [
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 0
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 1
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 2
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 3
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 4
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 5
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 6
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 7
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 8
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 9
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 10
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 11
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 12
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 13
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 14
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 15
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 16
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 17
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 18
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 19
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 20
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 21
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 22
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 23
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 24
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 25
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 26
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 27
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 28
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 29
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 30
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 31
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 32
    [0x18, 0x3C, 0x3C, 0x18, 0x18, 0x00, 0x18, 0x00], // 33
    [0x36, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 34
    [0x36, 0x36, 0x7F, 0x36, 0x7F, 0x36, 0x36, 0x00], // 35
    [0x0C, 0x3E, 0x03, 0x1E, 0x30, 0x1F, 0x0C, 0x00], // 36
    [0x00, 0x63, 0x33, 0x18, 0x0C, 0x66, 0x63, 0x00], // 37
    [0x1C, 0x36, 0x1C, 0x6E, 0x3B, 0x33, 0x6E, 0x00], // 38
    [0x06, 0x06, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00], // 39
    [0x18, 0x0C, 0x06, 0x06, 0x06, 0x0C, 0x18, 0x00], // 40
    [0x06, 0x0C, 0x18, 0x18, 0x18, 0x0C, 0x06, 0x00], // 41
    [0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00], // 42
    [0x00, 0x0C, 0x0C, 0x3F, 0x0C, 0x0C, 0x00, 0x00], // 43
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x06], // 44
    [0x00, 0x00, 0x00, 0x3F, 0x00, 0x00, 0x00, 0x00], // 45
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x0C, 0x0C, 0x00], // 46
    [0x60, 0x30, 0x18, 0x0C, 0x06, 0x03, 0x01, 0x00], // 47
    [0x3E, 0x63, 0x73, 0x7B, 0x6F, 0x67, 0x3E, 0x00], // 48
    [0x0C, 0x0E, 0x0C, 0x0C, 0x0C, 0x0C, 0x3F, 0x00], // 49
    [0x1E, 0x33, 0x30, 0x1C, 0x06, 0x33, 0x3F, 0x00], // 50
    [0x1E, 0x33, 0x30, 0x1C, 0x30, 0x33, 0x1E, 0x00], // 51
    [0x38, 0x3C, 0x36, 0x33, 0x7F, 0x30, 0x78, 0x00], // 52
    [0x3F, 0x03, 0x1F, 0x30, 0x30, 0x33, 0x1E, 0x00], // 53
    [0x1C, 0x06, 0x03, 0x1F, 0x33, 0x33, 0x1E, 0x00], // 54
    [0x3F, 0x33, 0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x00], // 55
    [0x1E, 0x33, 0x33, 0x1E, 0x33, 0x33, 0x1E, 0x00], // 56
    [0x1E, 0x33, 0x33, 0x3E, 0x30, 0x18, 0x0E, 0x00], // 57
    [0x00, 0x0C, 0x0C, 0x00, 0x00, 0x0C, 0x0C, 0x00], // 58
    [0x00, 0x0C, 0x0C, 0x00, 0x00, 0x0C, 0x0C, 0x06], // 59
    [0x18, 0x0C, 0x06, 0x03, 0x06, 0x0C, 0x18, 0x00], // 60
    [0x00, 0x00, 0x3F, 0x00, 0x00, 0x3F, 0x00, 0x00], // 61
    [0x06, 0x0C, 0x18, 0x30, 0x18, 0x0C, 0x06, 0x00], // 62
    [0x1E, 0x33, 0x30, 0x18, 0x0C, 0x00, 0x0C, 0x00], // 63
    [0x3E, 0x63, 0x7B, 0x7B, 0x7B, 0x03, 0x1E, 0x00], // 64
    [0x0C, 0x1E, 0x33, 0x33, 0x3F, 0x33, 0x33, 0x00], // 65
    [0x3F, 0x66, 0x66, 0x3E, 0x66, 0x66, 0x3F, 0x00], // 66
    [0x3C, 0x66, 0x03, 0x03, 0x03, 0x66, 0x3C, 0x00], // 67
    [0x1F, 0x36, 0x66, 0x66, 0x66, 0x36, 0x1F, 0x00], // 68
    [0x7F, 0x46, 0x16, 0x1E, 0x16, 0x46, 0x7F, 0x00], // 69
    [0x7F, 0x46, 0x16, 0x1E, 0x16, 0x06, 0x0F, 0x00], // 70
    [0x3C, 0x66, 0x03, 0x03, 0x73, 0x66, 0x7C, 0x00], // 71
    [0x33, 0x33, 0x33, 0x3F, 0x33, 0x33, 0x33, 0x00], // 72
    [0x1E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x1E, 0x00], // 73
    [0x78, 0x30, 0x30, 0x30, 0x33, 0x33, 0x1E, 0x00], // 74
    [0x67, 0x66, 0x36, 0x1E, 0x36, 0x66, 0x67, 0x00], // 75
    [0x0F, 0x06, 0x06, 0x06, 0x46, 0x66, 0x7F, 0x00], // 76
    [0x63, 0x77, 0x7F, 0x7F, 0x6B, 0x63, 0x63, 0x00], // 77
    [0x63, 0x67, 0x6F, 0x7B, 0x73, 0x63, 0x63, 0x00], // 78
    [0x1C, 0x36, 0x63, 0x63, 0x63, 0x36, 0x1C, 0x00], // 79
    [0x3F, 0x66, 0x66, 0x3E, 0x06, 0x06, 0x0F, 0x00], // 80
    [0x1E, 0x33, 0x33, 0x33, 0x3B, 0x1E, 0x38, 0x00], // 81
    [0x3F, 0x66, 0x66, 0x3E, 0x36, 0x66, 0x67, 0x00], // 82
    [0x1E, 0x33, 0x07, 0x0E, 0x38, 0x33, 0x1E, 0x00], // 83
    [0x3F, 0x2D, 0x0C, 0x0C, 0x0C, 0x0C, 0x1E, 0x00], // 84
    [0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x3F, 0x00], // 85
    [0x33, 0x33, 0x33, 0x33, 0x33, 0x1E, 0x0C, 0x00], // 86
    [0x63, 0x63, 0x63, 0x6B, 0x7F, 0x77, 0x63, 0x00], // 87
    [0x63, 0x63, 0x36, 0x1C, 0x1C, 0x36, 0x63, 0x00], // 88
    [0x33, 0x33, 0x33, 0x1E, 0x0C, 0x0C, 0x1E, 0x00], // 89
    [0x7F, 0x63, 0x31, 0x18, 0x4C, 0x66, 0x7F, 0x00], // 90
    [0x1E, 0x06, 0x06, 0x06, 0x06, 0x06, 0x1E, 0x00], // 91
    [0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x40, 0x00], // 92
    [0x1E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x1E, 0x00], // 93
    [0x08, 0x1C, 0x36, 0x63, 0x00, 0x00, 0x00, 0x00], // 94
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF], // 95
    [0x0C, 0x0C, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00], // 96
    [0x00, 0x00, 0x1E, 0x30, 0x3E, 0x33, 0x6E, 0x00], // 97
    [0x07, 0x06, 0x06, 0x3E, 0x66, 0x66, 0x3B, 0x00], // 98
    [0x00, 0x00, 0x1E, 0x33, 0x03, 0x33, 0x1E, 0x00], // 99
    [0x38, 0x30, 0x30, 0x3e, 0x33, 0x33, 0x6E, 0x00], // 100
    [0x00, 0x00, 0x1E, 0x33, 0x3f, 0x03, 0x1E, 0x00], // 101
    [0x1C, 0x36, 0x06, 0x0f, 0x06, 0x06, 0x0F, 0x00], // 102
    [0x00, 0x00, 0x6E, 0x33, 0x33, 0x3E, 0x30, 0x1F], // 103
    [0x07, 0x06, 0x36, 0x6E, 0x66, 0x66, 0x67, 0x00], // 104
    [0x0C, 0x00, 0x0E, 0x0C, 0x0C, 0x0C, 0x1E, 0x00], // 105
    [0x30, 0x00, 0x30, 0x30, 0x30, 0x33, 0x33, 0x1E], // 106
    [0x07, 0x06, 0x66, 0x36, 0x1E, 0x36, 0x67, 0x00], // 107
    [0x0E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x1E, 0x00], // 108
    [0x00, 0x00, 0x33, 0x7F, 0x7F, 0x6B, 0x63, 0x00], // 109
    [0x00, 0x00, 0x1F, 0x33, 0x33, 0x33, 0x33, 0x00], // 110
    [0x00, 0x00, 0x1E, 0x33, 0x33, 0x33, 0x1E, 0x00], // 111
    [0x00, 0x00, 0x3B, 0x66, 0x66, 0x3E, 0x06, 0x0F], // 112
    [0x00, 0x00, 0x6E, 0x33, 0x33, 0x3E, 0x30, 0x78], // 113
    [0x00, 0x00, 0x3B, 0x6E, 0x66, 0x06, 0x0F, 0x00], // 114
    [0x00, 0x00, 0x3E, 0x03, 0x1E, 0x30, 0x1F, 0x00], // 115
    [0x08, 0x0C, 0x3E, 0x0C, 0x0C, 0x2C, 0x18, 0x00], // 116
    [0x00, 0x00, 0x33, 0x33, 0x33, 0x33, 0x6E, 0x00], // 117
    [0x00, 0x00, 0x33, 0x33, 0x33, 0x1E, 0x0C, 0x00], // 118
    [0x00, 0x00, 0x63, 0x6B, 0x7F, 0x7F, 0x36, 0x00], // 119
    [0x00, 0x00, 0x63, 0x36, 0x1C, 0x36, 0x63, 0x00], // 120
    [0x00, 0x00, 0x33, 0x33, 0x33, 0x3E, 0x30, 0x1F], // 121
    [0x00, 0x00, 0x3F, 0x19, 0x0C, 0x26, 0x3F, 0x00], // 122
    [0x38, 0x0C, 0x0C, 0x07, 0x0C, 0x0C, 0x38, 0x00], // 123
    [0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x00], // 124
    [0x07, 0x0C, 0x0C, 0x38, 0x0C, 0x0C, 0x07, 0x00], // 125
    [0x6E, 0x3B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 126
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 127
];

/// Expand the 8x8 ASCII data into the 8x16 format used by the rendering paths
/// while also seeding a fallback box glyph for missing characters.
BitmapFont createBuiltInBitmapFont() @nogc nothrow
{
    BitmapFont font;
    foreach (index; 0 .. 128)
    {
        foreach (row; 0 .. glyphHeight)
        {
            font.glyphs[index][row] = font8x8Basic[index][row / 2];
        }
    }

    font.fallback = [
        cast(ubyte)0b1111_1111,
        cast(ubyte)0b1000_0001,
        cast(ubyte)0b1000_0001,
        cast(ubyte)0b1000_0001,
        cast(ubyte)0b1000_0001,
        cast(ubyte)0b1000_0001,
        cast(ubyte)0b1000_0001,
        cast(ubyte)0b1000_0001,
        cast(ubyte)0b1000_0001,
        cast(ubyte)0b1000_0001,
        cast(ubyte)0b1000_0001,
        cast(ubyte)0b1000_0001,
        cast(ubyte)0b1000_0001,
        cast(ubyte)0b1000_0001,
        cast(ubyte)0b1000_0001,
        cast(ubyte)0b1111_1111,
    ];

    font.available = true;
    return font;
}

/// Convert a glyph to an 8-bit alpha mask suitable for blitting.
bool glyphMask(const BitmapFont* font, dchar codepoint, ref ubyte[glyphWidth * glyphHeight] mask) @nogc nothrow
{
    if (font is null || !font.available)
    {
        return false;
    }

    const size_t glyphIndex = (codepoint < 128) ? cast(size_t) codepoint : size_t.max;
    const ubyte[glyphHeight]* source = (glyphIndex < 128) ? &font.glyphs[glyphIndex] : &font.fallback;

    foreach (row; 0 .. glyphHeight)
    {
        const ubyte bits = (*source)[row];
        foreach (col; 0 .. glyphWidth)
        {
            const maskBit = cast(ubyte)(0x01 << col);
            mask[row * glyphWidth + col] = (bits & maskBit) ? 0xFF : 0x00;
        }
    }

    return true;
}
